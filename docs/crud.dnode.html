<!DOCTYPE html>  <html> <head>   <title>crud.dnode.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="auth.dnode.html">                 auth.dnode.js               </a>                                           <a class="source" href="crud.dnode.html">                 crud.dnode.js               </a>                                           <a class="source" href="gravatar.dnode.html">                 gravatar.dnode.js               </a>                                           <a class="source" href="misc.dnode.html">                 misc.dnode.js               </a>                                           <a class="source" href="pubsub.dnode.html">                 pubsub.dnode.js               </a>                                           <a class="source" href="upload.dnode.html">                 upload.dnode.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               crud.dnode.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Aebleskiver
 (c) 2011 Beau Sorensen
 Backbone may be freely distributed under the MIT license.
 For all details and documentation:
 https://github.com/sorensen/aebleskiver</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="err">ß</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Backbone DNode CRUD</h2>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Backbone CRUD routines to be called from the ß.Server 
or delegated through the pub/sub protocol</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="err">ß</span><span class="p">.</span><span class="nx">Protocols</span><span class="p">.</span><span class="nx">CRUD</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">con</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Delegate to the 'synced' event unless further extention is 
needed per CRUD event</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">created</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Store</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Model processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Collection processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="nx">model</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">},</span>
            
            <span class="nx">read</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Store</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Model Processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Collection processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">resp</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">model</span><span class="p">.</span><span class="nx">reset</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">model</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">},</span>
            
            <span class="nx">updated</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Store</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Collection processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Model processing</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">},</span>
            
            <span class="nx">destroyed</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="err">ß</span><span class="p">.</span><span class="nx">Store</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span><span class="p">].</span><span class="nx">remove</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="o">||</span> <span class="k">delete</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Store</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span><span class="p">];</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">},</span>
        </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The following procedures will only work for the acting client, 
this may prove to be useful for future procedures </p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">selfCreated</span>   <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">synced</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">},</span>
            <span class="nx">selfRead</span>      <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">synced</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">},</span>
            <span class="nx">selfUpdated</span>   <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">synced</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">},</span>
            <span class="nx">selfDestroyed</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">synced</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Default synchronization event, call to Backbones internal
'success' method, then the custom 'finished' method when 
everything has been completed</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">synced</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getMongoId</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Call to Backbone's predefined 'success' method which 
is created per each 'sync' event, then to an optional
'finished' method for any final procedures</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">finished</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Add to underscore utility functions to allow optional usage
This will allow other storage options easier to manage, such as
'localStorage'. This must be set on the model and collection to 
be used on directly. Defaults to 'Backbone.sync' otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">mixin</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Set the model or collection's sync method to communicate through DNode</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">sync</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="err">ß</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="mi">503</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">));</span>
            </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Remove the Backbone id from the model as not to conflict with 
Mongoose schemas, it will be re-assigned when the model returns
to the client side</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Set the RPC options for model interaction</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">options</span><span class="p">.</span><span class="nx">type</span>      <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">type</span> <span class="o">||</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">url</span>       <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">channel</span>   <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">method</span>    <span class="o">||</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">);</span>
            </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Delegate method call based on action</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">switch</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;read&#39;</span>   <span class="o">:</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">read</span><span class="p">({},</span> <span class="nx">options</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;create&#39;</span> <span class="o">:</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">options</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;update&#39;</span> <span class="o">:</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">options</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;delete&#39;</span> <span class="o">:</span> <span class="err">ß</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">options</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">});</span>
    
<span class="p">})(</span><span class="err">ß</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 